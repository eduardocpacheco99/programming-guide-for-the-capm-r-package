```{r knitsetup, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=FALSE}
library(knitr)
opts_knit$set(base.dir='./')
opts_chunk$set(prompt=TRUE, comment='', fig.path='figures/')
options(width = 66)
```

```{r,results='hide',echo=FALSE}
library(capm)
psu.ssu <- read.csv(file = 'psu.ssu.csv')
set.seed(4)
pilot.psu <- SamplePPS(psu.ssu = psu.ssu,
                       psu = 10,
                       write = FALSE)
set.seed(4)
pilot.ssu <- SampleSystematic(
   psu.ssu = pilot.psu,
    su = 5, write = FALSE)
final.psu <- SamplePPS(psu.ssu, 20, write = F)
final.ssu <- SampleSystematic(final.psu, 15, write = F)
```

## Estimando características demográficas

Habiendo definido la muestra final, supongamos que fuimos a visitar todas las residencias seleccionadas y los datos colectados fueron guardados en un archivo llamado `survey.data.csv` (la página de ayuda de `survey.data` describe las variables).

```{r}
survey.data <- read.csv('survey.data.csv')
head(survey.data)
```

Para estimar los parámetros poblacionales, el primer paso es definir el diseño muestral que dió origen a los datos. Para hacerlo, necesitamos un archivo con todas las unidades muestrales de la población (`psu.ssu`) y un archivo con los datos muestrales (`survey.data`). Este último archivo, debe tener una columna con las UPM, otra con las USM y otra con el número de UPM incluídas en la muestra (si una UPM fue seleccionada más de una vez, cada ocurrencia debe ser contada).

```{r}
design <- DesignSurvey(sample = survey.data,
                       psu.ssu = psu.ssu,
                       psu.col = 2,
                       ssu.col = 1,
                       psu.2cd = 20)
```

Definir el tipo de estimativa para cada variable es facil.

```{r}
variables <- c('total', 'prop', 'mean', 'prop',
               'prop', 'total', rep('prop', 8))
```

Es conveniente confirmar que hemos definido el tipo de estimativa que queremos.

```{r}
cbind(names(design$variables), variables)
```

Ahora estamos listos para obtener nuestras primeras estimativas.

```{r}
(estimates <- SummarySurvey(design = design,
                            variables = variables,
                            rnd = 3))
```

El resultado anterior es bastante útil pero puede no ser suficiente. Hagamos una copia (`sample1`) de un subconjunto de `survey.data`, para estimar el total de animales esterilizados (en lugar de la proporción) y para obtener estimativas condicionadas por el sexo.

```{r}
sample1 <-
    survey.data[, c('interview_id', 'psu',
                    'dogs', 'sex', 'sterilized',
                    'sterilized.ly', 'fate')]
sample1[, 'sterilized'] <-
    as.character(sample1[, 'sterilized'])
sample1[which(sample1$sterilized == 'yes'),
        'sterilized'] <- 1
sample1[which(sample1[, 'sterilized'] == 'no'),
        'sterilized'] <- 0
sample1[, 'sterilized'] <-
    as.numeric(sample1[, 'sterilized'])
```

Despúes de definir el diseño muestral de la forma usual

```{r}
design.sex <- DesignSurvey(sample = sample1,
                           psu.ssu = psu.ssu,
                           psu.col = 2,
                           ssu.col = 1,
                           psu.2cd = 20)
```

podemos crear un diseño para cada sexo.

```{r}
design.f <- subset(design.sex, sex == 'Female')
design.m <- subset(design.sex, sex == 'Male')
```

A partir de aquí no hay nada nuevo.

```{r}
# Comillas cerradas exculyen una variable
# del processo de estimación.
names(design.sex$variables)
variables.sex <- c('total', '', 'total', 
                   'prop', 'prop')
cbind(names(design.sex$variables),
      variables.sex)
(estimates.f <- SummarySurvey(design.f,
                              variables.sex,
                              rnd = 3))
(estimates.m <- SummarySurvey(design.m,
                              variables.sex,
                              rnd = 3))
```

