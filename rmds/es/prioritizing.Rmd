```{r knitsetup, echo=FALSE, results='hide', warning=FALSE, message=FALSE, cache=FALSE}
library(knitr)
opts_knit$set(base.dir='./')
opts_chunk$set(prompt=TRUE, comment='', fig.path='figures/')
```

```{r,results='hide',echo=FALSE}
library(capm)
```

```{r,echo=FALSE,results='hide'}
# Owned dogs            # Stray dogs
f1 <- 39565 - 12783;    f2 <- f1 * 0.1
fs1 <- 12783;           fs2 <- fs1 * 0.05
m1 <- 50289 - 9346;     m2 <- m1 * 0.1
ms1 <- 9346;            ms2 <- ms1 * 0.05

# Owned dogs            # Stray dogs
b1 <-  7724;            b2 <- b1 * 0.15
df1 <- 0.046;           df2 <- df1 * 1.15
dm1 <- 0.053;           dm2 <- dm1 * 1.15
sf1 <- 0.13;            sf2 <- sf1 * 0.05
sm1 <- 0.043;           sm2 <- sm1 * 0.05
k1 <- (f1 + m1) * 1.1;  k2 <- (f2 + m2) * 1.1
h1 <- 1;                h2 <- 0.5;
a <- 0.05;              alpha <- 0.104;
v <- 0.147
z <- v * 0.11

init.solve.iasa = c(
  f1 = f1, fs1 = fs1,
  m1 = m1, ms1 = ms1,
  f2 = f2, fs2 = fs2,
  m2 = m2, ms2 = ms2)

pars.solve.iasa = c(
  b1 = b1, b2 = b2, df1 = df1,
  dm1 = dm1, df2 = df2, dm2 = dm2,
  sf1 = sf1, sf2 = sf2, sm1 = sm1,
  sm2 = sm2, k1 = k1, k2 = k2,
  h1 = h1, h2 = h2, a = a,
  alpha = alpha, v = v, z = z)

solve.iasa.pt <- SolveIASA(
  pars = pars.solve.iasa,
  init = init.solve.iasa,
  time = 0:20, method = 'rk4')
```

Para finalizar, haremos análisis de sensibilidad global y local para clasificar los parámetros de acuerdo con la influencia que ejercen. Dado que las intervenciones de manejo poblacional son mecanismos para modificar (o mantener estables) parámetros poblacionales, la clasificación de parámetros es también una clasificación de intervenciones, o en otras palabras, una forma de priorizar las intervenciones.

Los análisis de sensibilidad global son usadas para evaluar la contribución de los parámetros del modelo, en la variación de los resultados. Con los análisis de sensibilidad global es posible adicionar incertezas a todos los parámetros y evaluar el efecto que produzen conjuntamente en la dinámica poblacional. A continuación perturbaremos simultáneamente cada parámetro en un intervalo cuyos límites inferior y superior son respectivamente, 10% menores y 10% superiores a las estimativas puntuales (para las capacidades de carga, no consideraremos valores menores a las estimativas puntuales).

```{r global_sens_all}
rg.solve.iasa <-
    SetRanges(pars = pars.solve.iasa,
              range = 0.1)
glob.all.solve.iasa <- CalculateGlobalSens(
    model.out = solve.iasa.pt,
    ranges = rg.solve.iasa,
    sensv = 'ns1', all = T)
PlotGlobalSens(global.out = glob.all.solve.iasa,
               x.label = 'Años',
               y.label = 'Población',
               legend.label = 'Rango de sensibilidad',
               sd.label = 'media +- sd    ')
glob.all.solve.iasa
```

A diferencia de simulaciones basadas solo en estimativas puntuales, aquí obtuvimos un conjunto de posibles resultados representados por una envoltura, en lugar de un único resultado representado por una línea.  

Para algunos parámetros obtuvimos las estimativas usando técnicas de muestreo mientras que para otros, las estimativas fueron subjetivas. Dado que hay incertezas en relación a los valores exactos de los parámetros, los resultados de las perturbaciones también representan nuestras incertezas.  

Una questión que surge es: ¿La dinámica poblacional es igualmente sensible a todos los parámetros? Si no ¿Cuáles son los parametros más influyentes? Una forma de responder estas preguntas consiste en la realización de análisis de sensibilidad global, perturbando un parámetro por vez y fijando los restantes en las estimativas puntuales.

```{r global_sens}
glob.solve.iasa <- CalculateGlobalSens(
    model.out = solve.iasa.pt,
    ranges = rg.solve.iasa,
    sensv = 'ns1', all = F)
PlotGlobalSens(global.out = glob.solve.iasa,
               x.label = 'Años',
               y.label = 'Población',
               legend.label = 'Rango de sensibilidad',
               sd.label = 'media +- sd    ')
head(glob.solve.iasa)
```

Otra forma consiste en la realización de análisis de sensibilidad local. Aquí la idea es realizar pequñas perturbaciones y determinar la sensibilidad de cada parámetro usando medidas de influencia.

```{r local_sens}
local.solve.iasa <-
    CalculateLocalSens(model.out = solve.iasa.pt,
                       sensv = 'ns1')
PlotLocalSens(local.out = local.solve.iasa)
summary(local.solve.iasa)
```

Al ver las sensibilidades globales de cada parámetro y las sensibilidades locales, es claro que la capacidad de carga de la población de perros de casa es de lejos el parámetro más influyente para el total de perros de casa (cuanto mayor la envoltura (o la barra), mayor la influencia del respectivo parámetro).